%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#00f3ff', 'edgeLabelBackground':'#1a1a25', 'tertiaryColor': '#2d2d3a'}}}%%
graph TD
    %% ==================== [Ê†∑ÂºèÂÆö‰πâ] ====================
    classDef backend fill:#003f5c,stroke:#00f3ff,stroke-width:2px,color:#fff;
    classDef frontend fill:#2d2d3a,stroke:#ff003c,stroke-width:2px,color:#fff;
    classDef storage fill:#ffb400,stroke:#none,color:#000;
    classDef interact fill:#7b1fa2,stroke:#fff,stroke-width:1px,color:#fff;
    classDef decision fill:#000,stroke:#00f3ff,stroke-width:2px,color:#fff;

    %% ==================== [ÂêéÁ´ØÊµÅÁ®ã] ====================
    subgraph Backend [üêç Backend (run.py)]
        direction TB
        Start((üöÄ Start)) --> CheckEnv[Ê£ÄÊü•ÁéØÂ¢É/‰æùËµñ]
        CheckEnv --> Login{ÈúÄÁôªÂΩï?}
        Login -- Yes --> QR[Êâ´Á†ÅÁôªÂΩï (Playwright)]
        QR --> Scrape[üìú ÊªöÂä®ÊäìÂèñÊî∂ËóèÂ§π]
        Login -- No --> Scrape
        Scrape --> Extract[ÊèêÂèñÂÖÉÊï∞ÊçÆ\n(ID/Title/CoverURL)]
        Extract --> Download[‚¨áÔ∏è ÂºÇÊ≠•Âπ∂Âèë‰∏ãËΩΩÂ∞ÅÈù¢]
        Download --> SaveMeta{‰øùÂ≠òÊï∞ÊçÆ}
        SaveMeta --> Server[ÂêØÂä® HTTP Server\nPort 5000]
        
        %% ÂêéÁ´Ø API ÊúçÂä°
        Server --> API_Resolve[API: /api/resolve_video\nËß£ÊûêÁúüÂÆûÂú∞ÂùÄ]
        Server --> API_Proxy[API: /proxy_video\nÊµÅÂºè‰ª£ÁêÜËßÜÈ¢ë/ÂõæÁâá]
        Server --> API_Save[API: /api/save_data\nË¶ÜÂÜô metadata.json]
    end

    %% ==================== [ÂâçÁ´ØÂàùÂßãÂåñ] ====================
    subgraph Frontend_Init [üñ•Ô∏è Frontend Initialization]
        LoadPage(ÊâìÂºÄ index.html) --> LoadSettings[ËØªÂèñ LocalStorage ÈÖçÁΩÆ\n(Â∏ÉÂ±Ä/Hero/DarkMode)]
        LoadSettings --> InitUI[ÂàùÂßãÂåñ AutoScroller\nÂàùÂßãÂåñ Glitch ÊñáÂ≠óÁâπÊïà]
        InitUI --> LoadData{ÊúâÊú¨Âú∞ÁºìÂ≠ò?}
        LoadData -- Yes -> RenderLocal[Ê∏≤Êüì LocalStorage Êï∞ÊçÆ]
        LoadData -- No -> FetchServer[ËØ∑Ê±Ç data/metadata.json]
        FetchServer --> RenderServer[Ê∏≤ÊüìÊúçÂä°Âô®Êï∞ÊçÆ]
        
        RenderLocal & RenderServer --> InitMasonry[üìê Masonry ÁÄëÂ∏ÉÊµÅÂ∏ÉÂ±Ä]
        InitMasonry --> Observe[üëÅÔ∏è IntersectionObserver\nÂèåÂêëÊªöÂä®Âä®Áîª]
    end

    StartBrowser[Ëá™Âä®ÊâìÂºÄÊµèËßàÂô®] --> LoadPage
    Server --> StartBrowser

    %% ==================== [‰∏ªÁïåÈù¢‰∫§‰∫í] ====================
    subgraph Interaction [üéÆ Main Interaction]
        User((üë§ User)) --> Action_Scroll[üñ±Ô∏è ÊªöÂä®È°µÈù¢]
        Action_Scroll --> LazyLoad{Ëß¶Â∫ï?}
        LazyLoad -- Yes -> BatchLoad[Âä†ËΩΩ‰∏ã‰∏ÄÊâπ + Âä®Áîª]
        
        User --> Action_Click[üëÜ ÁÇπÂáªÊµ∑Êä•]
        Action_Click --> Lightbox[ÊâìÂºÄÁÅØÁÆ±È¢ÑËßà]
        
        Lightbox --> PlayVideo[‚ñ∂Ô∏è Êí≠ÊîæËßÜÈ¢ë]
        PlayVideo --> CallProxy[ËØ∑Ê±Ç /proxy_video\n(ÁªïËøáÈò≤ÁõóÈìæ/Ë∑®Âüü)]
        CallProxy -.-> API_Proxy

        User --> Action_Add[‚ûï Ê∑ªÂä†ËßÜÈ¢ë]
        Action_Add --> InputURL[ËæìÂÖ•ÂàÜ‰∫´ÈìæÊé•]
        InputURL --> CallResolve[ËØ∑Ê±Ç /api/resolve_video]
        CallResolve -.-> API_Resolve
        CallResolve --> UnshiftData[Ê∑ªÂä†Âà∞ÂàóË°®È¶ñ‰Ωç]
        UnshiftData --> AutoSave[üíæ Ëá™Âä®‰øùÂ≠ò]
    end

    %% ==================== [ÁºñËæëÊ®°Âºè] ====================
    subgraph EditMode [‚úèÔ∏è Edit Mode (Advanced)]
        ToggleEdit[ÂàáÊç¢ÁºñËæëÊ®°Âºè] --> EnableDrag[ÂêØÁî®ÊãñÊãΩÊéíÂ∫è (Sortable)]
        ToggleEdit --> EnableEdit[ÊñáÂ≠óÂèØÁºñËæë (contentEditable)]
        
        User --> CustomizeHero[üé® Ëá™ÂÆö‰πâ Hero]
        CustomizeHero --> UI_ChangeAvatar[ÁÇπÂáªÂ§¥ÂÉè -> ÈÄâÊã©Êñá‰ª∂]
        CustomizeHero --> UI_ChangeBg[ÁÇπÂáªËÉåÊôØ -> ÈÄâÊã©Êñá‰ª∂]
        UI_ChangeAvatar & UI_ChangeBg --> Compress[üñºÔ∏è ÂâçÁ´ØÂõæÁâáÂéãÁº©]
        Compress --> SaveSetting[‰øùÂ≠ò Base64 Âà∞ÈÖçÁΩÆ]

        User --> UI_CardEdit[ÁºñËæëÂç°Áâá]
        UI_CardEdit --> LightboxEdit[ÁÅØÁÆ±ÁºñËæëÁä∂ÊÄÅ]
        LightboxEdit --> EditTitle[‰øÆÊîπÊ†áÈ¢ò -> Ëá™Âä®‰øùÂ≠ò]
        LightboxEdit --> DeleteCard[üóëÔ∏è Âà†Èô§Âç°Áâá]
        
        LightboxEdit --> OpenFrameSelector[üéûÔ∏è Â∏ßÈÄâÊã©Âô®]
        
        %% Â∏ßÈÄâÊã©Âô®ÊµÅÁ®ã
        OpenFrameSelector --> CheckRealURL{ÊúâÁúüÂÆûMP4Âú∞ÂùÄ?}
        CheckRealURL -- No -> ResolveURL[Ëß£ÊûêÂú∞ÂùÄ]
        ResolveURL -.-> API_Resolve
        CheckRealURL -- Yes -> LoadProxyVideo[Âä†ËΩΩ‰ª£ÁêÜËßÜÈ¢ë]
        LoadProxyVideo --> Seek[ÊãñÂä®ËøõÂ∫¶Êù°]
        Seek --> Capture[üì∑ Êà™Âõæ (Canvas)]
        Capture --> ApplyCover[Â∫îÁî®‰∏∫Â∞ÅÈù¢]
        ApplyCover --> UpdateUI[Â±ÄÈÉ®Âà∑Êñ∞ DOM]
        UpdateUI --> AutoSave
    end

    %% ==================== [Êï∞ÊçÆÊåÅ‰πÖÂåñ] ====================
    subgraph Persistence [üíæ Data Persistence]
        AutoSave --> SaveLocal[ÂÜôÂÖ• LocalStorage]
        SaveLocal --> Debounce{Èò≤Êäñ/ÈÄÄÂá∫ÁºñËæë}
        Debounce --> SyncServer[POST /api/save_data]
        SyncServer -.-> API_Save
        
        User --> Export[üì§ ÂØºÂá∫ JSON]
        User --> Import[üì• ÂØºÂÖ• JSON]
        Import --> SaveLocal
    end

    %% Ë∑®Ê®°ÂùóËøûÊé•
    InitMasonry --> ToggleEdit
    BatchLoad --> InitMasonry
    Lightbox --> UI_CardEdit

    %% Ê†∑ÂºèÂ∫îÁî®
    class Start,CheckEnv,Scrape,Extract,Download,Server,API_Resolve,API_Proxy,API_Save backend;
    class LoadPage,LoadSettings,InitUI,InitMasonry,Observe,LoadData frontend;
    class SaveMeta,SaveLocal,SyncServer,Compress storage;
    class User,Action_Scroll,Action_Click,Action_Add,ToggleEdit,CustomizeHero,UI_CardEdit,OpenFrameSelector interact;
